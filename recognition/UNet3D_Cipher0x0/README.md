# 3D Unet for medical volumetric image segmentation

## Introduction
This project uses Unet-3D to train the [Prostate 3D](https://data.csiro.au/collection/csiro:51392v2) dataset to achieve medical volumetric image segmentation, using dice similarity coefficient for evaluation. Image segmentation is to convert an image into a collection of pixel areas represented by masks segmentation maps according to the labels. These segmentation maps can be used for medical condition analysis, symptom prediction, etc.

### Unet-3D
3D Unet is transformed from Unet. Unet is convolutional neural network structure used for segmenting 2D images, while 3D Unet can segmenting video and 3D images while being compatible with Unet. U-Net is a convolutional neural network developed for biomedical image segmentation. U-Net complements usual contracting networks with successive layers, where max pooling is replaced by upper-sampling, thereby greatly improving the accuracy of the output segmentation maps. This network is a type of autoencoder, including encoder and decoder.The network structure in this project as following:

![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/b2c6ddf4-d5af-4272-9ec5-c3e45f17c0a6)

## Result
![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/30fdb544-5b8b-4243-9654-3d72c37193d3)


The figures above show the dice similarity coefficient(DSC) of the model running for 60 epochs. The dataset is split in the ratio of training:validation:testing = 85.0%:7.5%:7.5%. The model reaches a plateau after about 30 epochs and the average of DSC reached over 0.9. 

![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/342dd974-0515-44fd-965a-b60b93371674)

The second figure shows the DSC of 6 kinds of segmentation divided into three groups. 0 and 1 have always maintained the DSC close to 100%. 2 and 3 showed an overall upward trend starting from epoch 0, and finally remained at around 90%. Although 4 and 5 performed poorly at the beginning, they eventually reached 80% DSC.

Shown below are some segmentations generated by the model:

![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/e349e54c-559b-48ef-b092-624a3830497b)

![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/d5a38267-0dab-420d-a186-c07ca972262c)

![image](https://github.com/Cipher0x0/PatternAnalysis-2023/assets/57138168/073211a4-2658-4ac8-9de6-1e6e30b21f3e)

## Quick start
To run this project, some packages are required:
 - os
 - glob
 - numpy
 - torch
 - torchvision
 - nibabel
 - matplotlib(if you want to plot segmentation)

This project is designed for Prostate 3D dataset. If you want to use other dataset, you may need to modify it. For train.py, the input should come from the dataloader in dataset.py. The dataloader will load all image files in .nii.gz format according to the path. Its output is val_loss, val_DSC and test_DSC returned for each epoch, as well as the .pth model file automatically saved after training is completed. predict.py shows how to use this file. You may get more detail  below:
`modules.py` contains the source code of Unet-3D. The network need receive tensor data with the shape B × C × H × W × D (batch_size, channel:1, height:256, width:256, depth:128).
`dataset.py` contains NiiImageLoader which is used for load nii image as tensor and split into training, validation and testing sets. If you are using other type of data,you may need to modify the dataloader.
`train.py` contains the main loop for training. It will return val dsc and test dsc every epoch. If you are using other datasets, you need to ensure the input channel and output channel are match.
`predict.py` shows an example of how to load the model been trained in `train.py`, generate and save the segmentation maps to nii image.

The test results showed above are based on running on GPU. If you need to run it on the CPU, please make sure your device has at least 32GB of RAM.

